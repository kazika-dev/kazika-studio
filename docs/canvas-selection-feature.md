# Canvas画像編集機能 - 選択・移動・削除機能

## 概要

Canvas画像エディタに、画像の一部を選択して移動または削除できる機能を追加しました。

## 追加された機能

### 1. 選択ツール（`select`モード）

**アイコン**: `CropFree`（矩形選択アイコン）

**機能**:
- ドラッグ＆ドロップで矩形の選択範囲を作成
- 選択範囲の画像データを保存（元の画像はそのまま）
- 選択範囲には青い点線の枠線と四隅にハンドルが表示される

**操作方法**:
1. ツールバーの「選択」ボタンをクリック
2. キャンバス上でドラッグして選択範囲を作成
3. マウスを離すと、選択範囲が確定（画像データが内部に保存される）

### 2. 選択範囲の移動

**機能**:
- 選択範囲をドラッグ＆ドロップで任意の場所に移動可能
- **移動開始時（クリック時）に元の位置が白で塗りつぶされる**
- 移動中は選択範囲の画像データがリアルタイムで表示される

**操作方法**:
1. 選択範囲が作成された状態で、選択範囲内をクリック
2. クリックした瞬間に元の位置が白く塗りつぶされる
3. そのままドラッグして好きな場所に移動
4. マウスを離すと移動が一時停止（まだ確定ではない）

### 3. 選択範囲の確定

**機能**:
- 選択範囲を現在の位置に貼り付けて確定
- 元の位置は既に白で塗りつぶされている（移動開始時に処理済み）

**操作方法**:
- 「確定 (Enter)」ボタンをクリック
- または、キーボードの **Enter** キーを押す

### 4. 選択範囲の削除

**機能**:
- 選択範囲の領域を白で塗りつぶして削除
- 削除後は選択範囲がクリアされる

**操作方法**:
- 「削除 (Delete)」ボタンをクリック
- または、キーボードの **Delete** キーを押す

### 5. 選択のキャンセル

**機能**:
- 選択範囲をクリアしてキャンセル
- **移動開始前の画像状態に復元**（移動で白く塗りつぶした部分も元に戻る）
- 移動していない場合は選択範囲を削除するだけ

**操作方法**:
- 「キャンセル (Esc)」ボタンをクリック
- または、キーボードの **Esc** キーを押す

## 技術的詳細

### データ構造

```typescript
interface SelectionArea {
  startX: number;        // 選択範囲の現在のX座標
  startY: number;        // 選択範囲の現在のY座標
  endX: number;          // 選択範囲の終了X座標
  endY: number;          // 選択範囲の終了Y座標
  imageData?: ImageData; // 選択した画像データ
  isDragging?: boolean;  // ドラッグ中フラグ
  originalX?: number;    // 選択時の元のX座標
  originalY?: number;    // 選択時の元のY座標
  savedImageBeforeMove?: HTMLImageElement;  // 移動前の画像状態（キャンセル用）
}
```

### 状態管理

- `selection`: 現在の選択範囲の情報
- `isCreatingSelection`: 選択範囲を作成中かどうか
- `isDraggingSelection`: 選択範囲をドラッグ中かどうか

### 画像データの処理

1. **選択範囲の作成**:
   - `ctx.getImageData(x, y, width, height)` で選択範囲の画像データを取得
   - **元の画像はそのまま（切り取らない）**
   - 取得した画像データを `selection.imageData` に保存
   - 元の位置を `selection.originalX`, `selection.originalY` に記録

2. **選択範囲の移動**:
   - **移動開始時（クリック時）に現在の画像状態を `savedImageBeforeMove` に保存**（キャンセル用）
   - 元の位置 (`originalX`, `originalY`) を白で塗りつぶす
   - 画像参照 (`imageRef.current`) を更新
   - ドラッグ中は `selection.startX`, `selection.startY`, `selection.endX`, `selection.endY` を更新
   - `redrawCanvas()` で毎フレーム再描画
   - 移動中は `selection.imageData` を現在の位置に表示

3. **選択範囲の確定**:
   - `ctx.putImageData(imageData, x, y)` で現在の位置に画像データを貼り付け
   - キャンバス全体を画像として保存し、`imageRef.current` を更新

4. **選択範囲の削除**:
   - 選択範囲の領域を白 (`#FFFFFF`) で塗りつぶす
   - `selection` を `null` にして選択をクリア
   - キャンバスを画像として保存し、`imageRef.current` を更新

5. **選択のキャンセル**:
   - `savedImageBeforeMove` が存在する場合は、その画像を復元
   - キャンバスをクリアして `savedImageBeforeMove` を描画
   - `imageRef.current` を `savedImageBeforeMove` に更新
   - `selection` を `null` にして選択をクリア

### UIコンポーネント

- **選択ツールボタン**: ツールバーに追加（`CropFree` アイコン）
- **操作ボタン**: 選択範囲が存在する場合のみ表示
  - 確定 (Enter)
  - 削除 (Delete)
  - キャンセル (Esc)

### キーボードショートカット

- **Enter**: 選択範囲を確定
- **Delete**: 選択範囲を削除
- **Esc**: 選択をキャンセル

## 使用例

### ワークフロー例

1. **画像の一部を切り取って移動**:
   ```
   選択ツールをクリック
   → 画像の一部をドラッグして選択（元の画像はそのまま）
   → 選択範囲内をクリック（クリックした瞬間に元の位置が白に）
   → ドラッグして好きな場所に移動
   → 「確定」ボタンをクリック（新しい位置に画像が貼り付けられる）
   ```

2. **画像の一部を削除**:
   ```
   選択ツールをクリック
   → 削除したい部分をドラッグして選択
   → 「削除」ボタンをクリック（または Delete キー）
   → 選択範囲が白で塗りつぶされる
   ```

3. **選択をやり直す（移動後にキャンセル）**:
   ```
   選択ツールをクリック
   → 画像の一部を選択
   → 選択範囲をドラッグして移動（元の位置が白に）
   → 間違えた場合は「キャンセル」ボタンをクリック（または Esc キー）
   → 移動前の状態に復元される（白く塗りつぶした部分も元に戻る）
   ```

4. **画像の一部をコピー（移動せずに確定）**:
   ```
   選択ツールをクリック
   → 画像の一部を選択
   → 移動せずに、そのまま「確定」ボタンをクリック
   → 元の画像の上に貼り付けられる（変化なし）
   ```

## 影響範囲

### 変更されたファイル

- `/components/outputs/ImageEditor.tsx`
  - `SelectionArea` インターフェースを追加
  - `DrawingMode` に `select` を追加
  - 選択範囲の作成・移動・削除・確定機能を実装
  - UIに選択ツールボタンと操作ボタンを追加

### 既存機能への影響

- **後方互換性**: 既存のペン、マーカー、消しゴム、テキスト、移動機能には影響なし
- **統合**: 既存の `redrawCanvas()` ロジックに選択範囲の描画を統合

## 今後の拡張可能性

- **選択範囲のリサイズ**: 四隅のハンドルをドラッグしてサイズ変更
- **選択範囲の回転**: 角度調整機能
- **複数の選択範囲**: 複数の範囲を同時に選択・操作
- **選択範囲のコピー**: 切り取りではなくコピーモード
- **自由選択**: 矩形以外の形状（楕円、多角形、フリーハンド）での選択

## ドキュメント更新日

2025-11-22
