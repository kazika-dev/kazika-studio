# Kazika Studio - Claude Code ドキュメント

このドキュメントは、Kazika Studio プロジェクトで Claude Code を使用する際の参考情報をまとめています。

## データベース接続テスト

### 概要

Supabase PostgreSQL データベースに直接接続してテーブル構造の確認やCRUD操作のテストを行う方法です。

### 環境情報

- **データベース**: Supabase PostgreSQL
- **接続方法**: 2つのアプローチ
  1. **REST API** (推奨): 外部依存なし、Python標準ライブラリのみ
  2. **PostgreSQL直接接続**: より詳細な情報取得が可能

### 1. REST APIを使用した接続テスト

#### 特徴
- ✅ 外部ライブラリ不要（Python標準ライブラリのみ）
- ✅ Supabase REST APIを使用
- ✅ 認証が必要なエンドポイントのテスト
- ⚠️ RLS（Row Level Security）の影響を受ける

#### 使用方法
```bash
cd /workspaces/kazika-studio
python3 .CLAUDE/.test/check_database_rest.py
```

#### 環境変数（.env.local から取得）
```
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
```

#### テンプレートコード
```python
import urllib.request
import json
import os
from dotenv import load_dotenv

load_dotenv('.env.local')

url = os.getenv('NEXT_PUBLIC_SUPABASE_URL')
key = os.getenv('NEXT_PUBLIC_SUPABASE_ANON_KEY')

# GETリクエスト例
req = urllib.request.Request(
    f'{url}/rest/v1/your_table?select=*',
    headers={
        'apikey': key,
        'Authorization': f'Bearer {key}'
    }
)
response = urllib.request.urlopen(req)
data = json.loads(response.read().decode())
print(json.dumps(data, indent=2, ensure_ascii=False))
```

### 2. PostgreSQL直接接続を使用したテスト

#### 特徴
- ✅ テーブル構造の詳細情報取得
- ✅ カラムの型・制約の確認
- ✅ RLSを回避してテスト可能
- ⚠️ psycopg2が必要

#### 必要なパッケージ
```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-psycopg2 python3-dotenv
```

#### 使用方法
```bash
cd /workspaces/kazika-studio
python3 .CLAUDE/.test/check_camera_tables.py
```

#### 環境変数（.env.local から取得）
```
SUPABASE_DB_HOST=aws-0-ap-northeast-1.pooler.supabase.com
SUPABASE_DB_PORT=6543
SUPABASE_DB_NAME=postgres
SUPABASE_DB_USER=postgres.xxx
SUPABASE_DB_PASSWORD=xxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...
```

#### テンプレートコード

**テーブル構造確認:**
```python
import psycopg2
import os
from dotenv import load_dotenv

load_dotenv('.env.local')

conn = psycopg2.connect(
    host=os.getenv('SUPABASE_DB_HOST'),
    port=os.getenv('SUPABASE_DB_PORT', 6543),
    database=os.getenv('SUPABASE_DB_NAME', 'postgres'),
    user=os.getenv('SUPABASE_DB_USER'),
    password=os.getenv('SUPABASE_DB_PASSWORD')
)

cursor = conn.cursor()

# テーブル構造確認
cursor.execute("""
    SELECT column_name, data_type, is_nullable, column_default
    FROM information_schema.columns
    WHERE table_schema = 'your_schema'
    AND table_name = 'your_table'
    ORDER BY ordinal_position
""")

for row in cursor.fetchall():
    print(row)

cursor.close()
conn.close()
```

**CRUD操作テスト:**
```python
# INSERT
cursor.execute("""
    INSERT INTO schema.table (name, description)
    VALUES (%s, %s)
    RETURNING id
""", ('Test', 'Test Description'))
test_id = cursor.fetchone()[0]
conn.commit()

# SELECT
cursor.execute("SELECT * FROM schema.table WHERE id = %s", (test_id,))
record = cursor.fetchone()

# UPDATE
cursor.execute("""
    UPDATE schema.table
    SET name = %s
    WHERE id = %s
""", ('Updated', test_id))
conn.commit()

# DELETE
cursor.execute("DELETE FROM schema.table WHERE id = %s", (test_id,))
conn.commit()
```

### トラブルシューティング

#### エラー: "permission denied for schema"
- **原因**: RLSポリシーまたは権限不足
- **解決策**:
  1. Service Role Keyを使用（PostgreSQL直接接続）
  2. RLSポリシーを確認・修正

#### エラー: "column does not exist"
- **原因**: カラム名のタイプミス
- **解決策**:
  1. PostgreSQL接続でテーブル構造を確認
  2. 正しいカラム名を使用

#### エラー: "No module named 'psycopg2'"
- **原因**: psycopg2未インストール
- **解決策**:
```bash
sudo apt-get install -y python3-psycopg2
```

### ベストプラクティス

1. **最初にテーブル構造を確認**
   - 実装前に必ずPostgreSQL直接接続でカラム名・型を確認
   - 仮定せず、実際のスキーマに基づいてコードを作成

2. **テストスクリプトを `.CLAUDE/.test/` に配置**
   - 再利用可能
   - バージョン管理対象外（.gitignore）

3. **環境変数は `.env.local` で管理**
   - 本番環境の認証情報を直接コードに書かない
   - `python-dotenv` で読み込み

4. **CRUD操作の完全テスト**
   - INSERT → SELECT → UPDATE → DELETE の順でテスト
   - テスト後はロールバックまたは削除して元の状態に戻す

5. **テストファイル命名規則**
   - `check_*.py` - データベース確認用
   - `test_*.py` または `test_*.mjs` - 機能テスト用

### 関連ファイルの配置場所

```
/workspaces/kazika-studio/
├── .env.local                          # 環境変数（Git管理外）
└── .CLAUDE/
    ├── .CLAUDE.md                      # このドキュメント
    └── .test/                          # テストスクリプト（Git管理外）
        ├── check_database_rest.py      # REST APIチェッカー
        ├── check_camera_tables.py      # PostgreSQL直接接続チェッカー
        ├── test-master-tables.mjs      # Node.js APIテスト
        └── check-tables-status.mjs     # Node.js ステータスチェック
```

## Supabase接続設定

### 接続エンドポイント

- **Transaction Pooler**: `aws-0-ap-northeast-1.pooler.supabase.com:6543`
  - 短時間のトランザクション向け
  - Next.js サーバーサイドで使用
  - 推奨: データベース接続テスト

- **Session Pooler**: `aws-0-ap-northeast-1.pooler.supabase.com:5432`
  - 長時間セッション向け
  - 管理ツールで使用

- **Direct Connection**: ポート 5432
  - プール経由しない直接接続
  - マイグレーションで使用

### 認証キー

- **Anon Key**: フロントエンド用（RLS適用）
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - REST API経由のアクセスに使用

- **Service Role Key**: サーバーサイド/管理用（RLS回避可能）
  - `SUPABASE_SERVICE_ROLE_KEY`
  - PostgreSQL直接接続やバックエンド処理に使用
  - ⚠️ 絶対にフロントエンドに公開しない

### スキーマ

- **public**: デフォルトスキーマ
- **kazikastudio**: カスタムスキーマ
  - マスターテーブルなどを配置

---

最終更新: 2025-11-15
